import argparse
import os

import torch
from torch.utils.flop_counter import FlopCounterMode
from transformers import AutoConfig, AutoModel, AutoModelForCausalLM, AutoTokenizer

from models.llama_dlo.configuration_llama_dlo import LlamaDLOConfig
from models.llama_dlo.configuration_llama_dlo_exattn import LlamaDLOExAttnConfig
from models.llama_dlo.modeling_llama_dlo import LlamaDLOModel, LlamaDLOForCausalLM
from models.llama_dlo.modeling_llama_dlo_exattn import LlamaDLOExAttnModel, LlamaDLOExAttnForCausalLM
from utils.io import create_dir

AutoConfig.register("llama_dlo", LlamaDLOConfig)
AutoConfig.register("llama_dlo_exattn", LlamaDLOExAttnConfig)

AutoModel.register(LlamaDLOConfig, LlamaDLOModel)
AutoModel.register(LlamaDLOExAttnConfig, LlamaDLOExAttnModel)

AutoModelForCausalLM.register(LlamaDLOConfig, LlamaDLOForCausalLM)
AutoModelForCausalLM.register(LlamaDLOExAttnConfig, LlamaDLOExAttnForCausalLM)


@torch.no_grad()
def main(args):
    model = AutoModelForCausalLM.from_pretrained(args.model_name_or_path)
    try:
        tokenizer = AutoTokenizer.from_pretrained(args.model_name_or_path, use_fast=True)
    except:
        tokenizer = AutoTokenizer.from_pretrained(args.model_name_or_path, use_fast=False)

    inputs = tokenizer.encode(
        "\"Bake me a pie or go away,\" I've literally had my son say that to me a few times. So, what was I to do except fulfilling his demand? Baking (not only pies), is a cooking method where tools DO actually make the man, which means that it is very hard or nearly impossible to do it successfully without proper bakeware.\nWith years of experience under my belt, I’ve learned about and discovered what truly matters when looking for bakeware to buy, and I am going to teach you later in the article.\nAlso, I have reviewed what I believe to be the best five non-stick bakeware sets out there, so make sure to check them out if you are in search of one.\nThe first and most obvious reason is – because food doesn’t stick to it! I do not want to sound overly simplistic, but any chef (or mom, as a matter of fact) knows that pans that stick will absolutely mess up the outcome.\nPeople normally solve this problem by oiling up, but I don’t like it since it makes the food greasy. Using non-stick bakeware is a healthier, more convenient, and more practical way of baking.\nThe next thing that you might not have known is that non-stick bakeware is so much easier to clean than more conventional types. It is a no-brainer really – if nothing sticks to the surface then there won’t be anything to scrub, scrape or wash off.\nThis trait right here will save you tons of time as well as frustration, and it might motivate you to bake more often because of the hassle-free cleaning process. Just make sure to maintain the bakeware.\nLastly, even heat distribution is another thing that you should look for, and this type of bakeware enables it.\nHere's the deal: heat distribution most likely won't affect the quality of the result, but it will make the bakeware heat up more quickly which will ultimately decrease the cooking time.\nInvesting a little bit of time into research can save you a lot of money and trouble in the long run, and that is why you need to read this section carefully.\nBakeware sets differ regarding materials, abilities, cost, and maintenance, so learning about some general features of these products will help you decide which type will fulfill your demands.\nBakeware can be made from different kinds of materials including iron, glass, copper, steel, etc.\nToday I will mention only the types that are related to products I reviewed in this article.\nIt is important to know that each material yields different cooking properties so study these paragraphs to find out which one is right for you.\nCarbon steel – this material is light, durable, and reacts to temperature changes very quickly, meaning that it can heat up fast. Even though is lightweight, it is a bit heavier than copper and doesn't retain heat as well as iron. It's a good choice for baking meats, veggies, bread, and cakes.\nCopper – it is an excellent heat conductor and doesn’t need pre-heating since it gets hot very quickly. Very light, but also quite expensive compared to other bakeware materials. Also, it isn’t the best choice for recipes that require baking under very high heat.\nSilicon – good for foods where sticking is an issue, such as breads, cookies, and cakes. It is light, affordable and dishes will slide out of it easily. The one downside is that it can be frustrating to wash because it is so elastic, but luckily, most of the silicon bakeware is dishwasher safe.\nSince you’ll be buying an entire set of products, it would be a good idea to find one that is suitable for all kinds of baking jobs. Make sure that all the basic items such as pie pan, muffin pan, loaf pan, cookie sheet, cake pan, or whatever you need, is included in the package.\nThis is a feature that most folks overlook, and it makes a world of difference when it comes to handling the pan. It's easy to move the dish around when it's cold but taking it out of a scorching hot oven is a different story (trust me, I know). You’ll try to be cautious not to burn your fingers so it is easy not to pay attention to the contents of the pan which can lead to spillage and a messy kitchen.\nLook for bakeware that has nice, ergonomic handles or handling areas. Some models have silicon added to these parts for extra protection and ease of use.\nNot all types of bakeware can withstand the same temperatures; as a matter of fact, this trait greatly differs from product to product. Certain pans are oven safe to up to 500 degrees Fahrenheit, while others cannot take more than 350.\nThis is a significant difference so pay close attention to this detail when buying a set.\nNow, let’s get into the meaty part of this article – the reviews.\nAfter trying out many sets, I’ve reached some conclusions and decided to put together a list of my favorite ones.\nKeep in mind that these are my personal choices, but they are also top rated products.\nRachel Ray is a world-renowned chef and TV personality, and her famous Cucina line of products never fails to deliver. Here, we are dealing with an excellent, 10-piece set that I personally think very highly of.\nThe material that this bakeware is made of is carbon steel, and the non-stick, latte-colored coating looks very pretty and does the job well.\nA thing that I didn’t like about the construction of this set is that everything is so bulky. It is not a huge issue, but folks who lack storage space will not be thrilled with these products.\nAs far as items are concerned, the set includes two loaf pans, two cake pans, two cookie sheets, two pie plates, a muffin tin, and a plastic cake pan topper.\nIn my opinion, this is more than enough, but I’m sure some folks are going to be disappointed because there’s no pizza pan included.\nThe handles have silicon grips attached to them, and this is a big bonus when it comes to practicality and handling. Also, the rolled edges allow you to grab the pan more easily and move it around securely.\nThe pan can withstand heat of up to 450 F, and I think that this should be sufficient for most baking jobs. Make sure not to go over this temperature because you could burn the pans.\nCopper has gained a lot of popularity in the cooking world over the last few years, and honestly, I can only say good things about it. Copper Chef is known for a plethora of cookware, and now we are taking a look at their baking set.\nAs I've mentioned before, copper is a fantastic heat conductor, and the heat distribution in this material is as even as it gets.\nPersonally, I find the latter feature very important because I like to have consistency in my cooking.\nThis is a 12-piece set that consists of a 12-cup muffin pan, a cookie sheet, a loaf pan, a square pan, and eight pieces of silicon ramekin cups with lids.\nOk, so I think it is a bit unfair for a company to advertise a set of twelve copper products while only four of them are actually made of this material. While the ramekin cups are lovely, they seem to be a cheap filler in this set.\nAs far as handling is concerned, most of the products in this pack do not have handles, so you have to rely on the rolled edges for gripping. This is a big disadvantage in my opinion, and greatly handicaps the ease of use.\nThese black, sturdy-looking baking dishes remind me of old-school bakeware sets that people used to bake with a few decades ago. However, this is a modern and versatile set that should fulfill most of your demands.\nThe ChefLand set is made of carbon steel; it looks pretty plain but has a non-stick coating that's quite effective. One thing that this material is good at is even heat distribution, so you won’t need to worry about hotspots.\nThe products are dishwasher safe, however, after several months of kind of cleaning, some items started to form rust on the outer edges, which is a big minus. I would recommend washing them by hand.\nWhen it comes to the items, ChefLand’s set includes a roasting pan, a round pizza pan, a large and medium cookie sheet, two round cake pans, a square cake pan, a loaf pan, an oven crisper pan, and a 12-cup muffin pan. As far as I’m concerned this set has everything covered!\nMost of the dishes have handles on them, and even those which don't, have a nice grip area that allows for good handling.\nUnfortunately, there is no silicon padding or protective surface so you will need to use gloves or cloth.\nThis bakeware set comes to us from Sunbeam; it is a bit smaller set in terms of the number of items in it, but a worthy addition to today's list. Oh, I forgot to mention it’s cheap as chips!\nThe material these pans are made of is carbon steel, and its non-stick features are achieved with a xylan coating interior and exterior. The black color gives it a pretty plain, non-exciting look, but I personally do not mind this.\nThe Sunbeam set has only 5-pieces, which is significantly less than other sets we reviewed today. The dishes included are a loaf pan, a cookie sheet, a 6-cup muffin pan, and two round cake pans.\nOne disadvantage of this set is that it cannot handle temperatures higher than 400 F, which is quite limiting because some recipes require more heat.\nAll of the pans have handles or enough room to grab them properly and handle safely.\nNow as I was reading some online commentary, many people complained that pans arrived dented or bent when they ordered them, so this might be an issue.\nI haven’t experienced this myself, so I just want to put it out as a warning.\nThis set differs from others I reviewed today because it is the only one that’s not made of metal.\nBoxiki Kitchen brings us this 3-piece silicone set that bread and cake lovers might find interesting.\nAs I’ve said, these products are made of silicone which has its pros and cons.\nThe good thing is that food will just slide out of it, but it might be irritating when trying to wash it by hand because it’s so bendy. A lot of people raise concerns about chemicals in this material, so you’ll be glad to know that this set is FDA approved and non-toxic.\nThe set comes with three items – a round cake pan, a square brownie pan, and a banana bread/meatloaf pan.\nAll of the dishes are equipped with metal handles which allows for a nice and solid grip, so you won’t have to worry about the pans slipping out of your hands.\nSilicone is generally oven safe up to 500 degrees F, which is fantastic and much better than some metal products, so you won’t need to worry about burning your bakeware.\nHowever, the metal handles don't seem to take high temperatures very well, and I've heard some reports of them flaking and bubbling at 400 F.\nI hope that the article was helpful and that it got you acquainted with the basics of bakeware.\nNow, the time has come for me to declare my top pick of the day, and the product that got most of my sympathies is Rachel Ray’s 10-piece Cucina Set.\nIts beautiful design is what attracted me to this bakeware set, but the excellent performance made an even stronger impression.\nNon-stick surface does its job flawlessly, and the carbon steel construction is sturdy and strong.\nThis is a very good list, i have tested myself the Rachel Ray’s 10-Piece Cucina Bakeware Set and i’m satisfied with it, it fulfill most of my daily cooking.",
        return_tensors="pt"
    )
    print("encoded:", inputs, inputs.shape)
    inputs = [inputs for _ in range(1 + args.seq_len // inputs.shape[1])]
    inputs = torch.cat(inputs, dim=1)[:, :args.seq_len]
    inputs = inputs.expand(args.batch_size, args.seq_len)
    inputs = inputs.to(args.device)
    print("extended:", inputs, inputs.shape)

    model.to(args.device)
    model.eval()

    flop_counter = FlopCounterMode(model, depth=5, display=True)
    with flop_counter:
        model(input_ids=inputs)
    print(flop_counter.get_total_flops())

    if args.save_file is not None:
        create_dir(os.path.dirname(args.save_file))
        with open(args.save_file, "w") as f:
            f.write(str(flop_counter.get_total_flops()) + "\n")
            f.write(str(flop_counter.get_table()))


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--model_name_or_path", type=str, default="TencentARC/LLaMA-Pro-8B")
    parser.add_argument("--save_file", type=str, default=None)
    parser.add_argument("--batch_size", type=int, default=1)
    parser.add_argument("--seq_len", type=int, default=2048)
    parser.add_argument("--device", type=str, default="cuda" if torch.cuda.is_available() else "cpu")
    args = parser.parse_args()
    main(args)
